
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>David Cramer's Blog</title>
    <meta name="author" content="David Cramer">

    
    <meta name="description" content="Large SQL Result Sets in Django One of the repetitive tasks that I always seem to have, is handling large amounts of data in chunks. That is, &hellip;">
    
    <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=1">

    <link href="http://feeds.feedburner.com/DavidCramernet" rel="alternate" title="David Cramer's Blog" type="application/atom+xml">
    <link rel="canonical" href="">
    <link href="/favicon.png" rel="shortcut icon">
    <link href="/stylesheets/screen.css?1" media="screen, projection" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4f0ffdc0844d521595000001');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
    

</head>

<body>
	<header class="inner"><h1><a href="/">David Cramer's Blog</a></h1>
<nav class="menu"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<div class="right">
	<form class="search right" action="http://google.com/search" method="get">
		<input class="left" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:justcramer.com">
	</form>
	<div class="social right">
		
		
		
		<a class="twitter" href="http://twitter.com/zeeg" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/dcramer" title="GitHub">GitHub</a>
		
		
		
		<a class="rss" href="http://feeds.feedburner.com/DavidCramernet" title="RSS">RSS</a>
		
	</div>
</div>

</header>
	<div id="content" class="inner">


    <article class="post">
    <h1 class="title"><a href="/2009/02/09/large-sql-result-sets-in-django">Large SQL Result Sets in Django</a></h1>
    <div class="entry">
        <p>One of the repetitive tasks that I always seem to have, is handling large amounts of data in chunks. That is, typically I loop through every row in the database, but the result set is too large, or too slow to take into memory all at once. After reading my code a few too many times, I realized how lazy I had been on the first iteration, and decided to dry it up.</p>

<p>So, the result, is a couple of useful classes for managing large QuerySet&#8217;s, and cursors in Django.</p>

<p>First let&#8217;s handle iterating over a large QuerySet. Let&#8217;s just say we have a million rows in our database, and need to write each one to the file. Now in some situations, this could be a locking query, which isn&#8217;t good. In others, it&#8217;s simply just too slow and network heavy to send all million rows over the network. What we do instead, which is a little bit slower (overall), is query for a chunk of data at a time, and simply yield the current results.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">IterableQuerySet</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Allows iteration over a QuerySet breaking it off into smaller chunks.&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">at</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="p">[</span><span class="n">at</span><span class="p">:</span><span class="n">at</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">]</span>
</span><span class='line'>        <span class="k">while</span> <span class="n">results</span><span class="p">:</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span><span class='line'>                <span class="k">yield</span> <span class="n">result</span>
</span><span class='line'>            <span class="n">at</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span>
</span><span class='line'>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="p">[</span><span class="n">at</span><span class="p">:</span><span class="n">at</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>

Now one of the other common tasks we had with similar applications, was doing something similar but with cursors. So instead of writing the same class, but for a cursor, we instead made a new class which would allow a cursor to easily act like a QuerySet. This one&#8217;s a bit more complex, but also allows you to use a Paginator class on it.

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'>
</span><span class='line'><span class="n">CURSOR_UNION_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^SELECT .*? FROM (.*)$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">QuerySetCursor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[],</span> <span class="n">model_class</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">params</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">connection</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span> <span class="o">=</span> <span class="n">sql</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span> <span class="o">=</span> <span class="n">model_class</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
</span><span class='line'>            <span class="k">raise</span> <span class="ne">TypeError</span>
</span><span class='line'>        <span class="k">assert</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> \
</span><span class='line'>            <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">stop</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)),</span> \
</span><span class='line'>                <span class="s">&quot;Negative indexing is not supported.&quot;</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="nb">slice</span><span class="p">:</span>
</span><span class='line'>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">&lt;</span> <span class="n">k</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">stop</span><span class="o">-</span><span class="n">k</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">:</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">):</span>
</span><span class='line'>                    <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="nb">slice</span><span class="p">:</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">stop</span><span class="o">-</span><span class="n">k</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_results</span><span class="p">()</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">k</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_results</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_results</span><span class="p">())</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">:</span>
</span><span class='line'>            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span> <span class="o">+</span> <span class="s">&#39; LIMIT </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span>
</span><span class='line'>            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">]</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>
</span><span class='line'>            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span class='line'>            <span class="n">results</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">:</span>
</span><span class='line'>                <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</span><span class='line'>        <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">results</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">statements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; UNION &#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">prepared</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">:</span>
</span><span class='line'>            <span class="n">end_of_stmt</span> <span class="o">=</span> <span class="n">CURSOR_UNION_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="n">end_of_stmt</span><span class="p">:</span>
</span><span class='line'>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Error getting SQL&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">prepared</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;SELECT COUNT(1) FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_of_stmt</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),))</span>
</span><span class='line'>        <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;SELECT (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;) + (&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prepared</span><span class="p">),)</span>
</span><span class='line'>        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
</span><span class='line'>            <span class="n">results</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>        <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">results</span>
</span></code></pre></td></tr></table></div></figure>

Want to combine both results?

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">IterableQuerySet</span><span class="p">(</span><span class="n">QuerySetCursor</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">MyModelClass</span><span class="p">)):</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">r</span>
</span></code></pre></td></tr></table></div></figure>
<p>I believe there&#8217;s also some optimization that can be doing with <code>cursor.fetchmany()</code> to also chunk the SQL in memory, but I&#8217;ve yet to research how the cursor classes work internally.</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-02-09T00:00:00-08:00" pubdate data-updated="true">Feb 9<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2009/02/05/lifestreams-evolution-into-a-platform">Lifestream&#8217;s Evolution Into a Platform</a></h1>
    <div class="entry">
        <p>One of the big things I&#8217;ve been talking about, and working on over the past couple of months (although I haven&#8217;t been working much on it), is our new Lifestream service. The goal is to simply create an open platform. A place where a user can sign up and add their feeds much like on FriendFeed, or one of those hundred clones. However, we have a slightly different vision from the limited scope that is FriendFeed.</p>

<p>We want to create a platform where this data is open to the user. A platform where they can use this data whenever, wherever, and however they want. Breaking down barriers between the data providers, and the user is not our only goal, but we also want to bring you a platform which goes above and beyond what the others offer. Allowing you to group and tweak your feeds (which are being relabled as sources) to your hearts desire.</p>

<p>Let&#8217;s take an example. In the current Lifestream plugin, you have a &#8220;Digg&#8221; extension. This is a chunk of actual code, which lets you say &#8220;I want to show my Digg submissions, Digg favorites, and other Diggness, and group them all together.&#8221;. This by itself is fairly powerful, and gives the user some choice.</p>

<p>There is no more code which powers Digg, instead we have a simply &#8220;Feed&#8221; extension which can power any RSS/Atom based feed. Instead, Digg exists as a virtual extension, which requires very little configuration, and can be used, and reused, by any user, as well as created very easily without much of a learning curve.</p>

<p>Even more so, we have completely scrapped our previous grouping concept. Instead of restricting groups to simply being media types from the same source, we now allow you to group ANY source together as long as it&#8217;s the same media type (images can&#8217;t be grouped with messages). This opens up some very cool possibilities like being able to group all of your trendy news sites together (Digg, Reddit), or group all your bookmark posts together (Delicious, Google).</p>

<p>Beyond just the technical details, we&#8217;re launching this as a service oriented platform. What this means is that you have a one-stop-shop to do whatever you want with your Lifestream, and then you can reuse that data on a variety of sources. Our initial release will include not only a WordPress plugin, but extensions for vBulletin, Blogger, and MediaWiki as well (pending time).</p>

<p>Not only are we launching with several extensions, but we will also provide a very simple, themeable homepage for the user much like Pownce or Tumblr. This will allow you to post directly to your Lifestream, but also give you the ability to pull in information like your tweets. Essentially, this opens up an entire new blogging approach which hasn&#8217;t been very well explored.</p>

<p>To the point. The service will be slowly opening up to users over the next month, and we hope to launch a fully open beta within the next 3-6 months. If you&#8217;re an extreme Lifestream fan, and you think you can really contribute in terms of feedback, and quality testing, we&#8217;re looking for you. Simply send me an <a href="mailto:dcramer@gmail.com/">email</a> letting me know that you are interested.</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-02-05T00:00:00-08:00" pubdate data-updated="true">Feb 5<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2008/12/29/denormalizing-model-abstraction-in-django">Denormalizing Model Abstraction in Django</a></h1>
    <div class="entry">
        <p>In the Lifestream service I&#8217;ve been working on, I presented myself with the need to have some class abstraction, but not in the fashion which is available in Django models. I wanted to achieve a base class, which is stored in the database, and then child classes which simply override some methods. It turned out this would be a lot more complex than anticipated.</p>

<p>This is a fairly common approach to class abstraction, especially in Python. It&#8217;s used all over the place in your daily code. Whether you are overriding the save() method on your model, or creating your own admin form by subclassing ModelAdmin. I wanted to accomplish a similar task, but doing so on a model. Let&#8217;s call it backwards abstraction (since abstraction works the other direction in Django). We create a single table, which houses many classes, and possibly even some denormalization for additional data on these classes.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">TemplateModel</span><span class="p">):</span>
</span><span class='line'><span class="nb">id</span>              <span class="o">=</span> <span class="n">UUIDField</span><span class="p">(</span><span class="n">auto</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'><span class="n">plugin</span>          <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</span><span class='line'><span class="n">title</span>           <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">options</span>         <span class="o">=</span> <span class="n">JSONField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Tell the TemplateModel class what we have called our field.</span>
</span><span class='line'><span class="n">__template_key__</span> <span class="o">=</span> <span class="s">&#39;plugin&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'><span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span></code></pre></td></tr></table></div></figure>

As you can see in the above, we have our base class. It&#8217;s extending from the TemplateModel class (more on this further in), and contains some basic information. We have a <code>plugin</code> field which is the name of the class which is extending the instance, and an <code>options</code> field for storing some extra information based on that class. There is also a <code>render()</code> method for the extension which should be handled by the subclass.

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">TwitterExtension</span><span class="p">(</span><span class="n">FeedExtension</span><span class="p">):</span>
</span><span class='line'><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span class='line'><span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">title</span>
</span></code></pre></td></tr></table></div></figure>

Our Twitter extension, for this sample, is very simple. All it does it say &#8220;Use the base Source class, and render the title of the event&#8221;. Now while this may not seem all that useful, it begins to be when we do even more complex development. To backtrack things a bit, <code>TwitterExtension</code> extends from the <code>FeedExtension</code>, which is where we are handling most of the logic.

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">FeedExtension</span><span class="p">(</span><span class="n">Source</span><span class="p">):</span>
</span><span class='line'><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span class='line'><span class="k">return</span> <span class="s">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">fetch_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
</span><span class='line'><span class="n">feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'><span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">feed</span><span class="p">[</span><span class="s">&#39;entries&#39;</span><span class="p">]:</span>
</span><span class='line'><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</span><span class='line'><span class="n">data</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_media_type_for_url</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</span><span class='line'><span class="n">data</span><span class="p">[</span><span class="s">&#39;signature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signature_for_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</span><span class='line'><span class="k">yield</span> <span class="n">data</span>
</span></code></pre></td></tr></table></div></figure>

As you can see here, we&#8217;re simply changing how the Twitter events are rendered. So simple example, complex to build. Even more so, we want these classes to automatically be delivered whenever we access the base Source class, as well as being able to use the classes directly.

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># The instance becomes a &lt;TwitterExtension: TwitterExtensionobject&gt; on creation.</span>
</span><span class='line'><span class="n">twitter</span> <span class="o">=</span> <span class="n">Source</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s">&#39;TwitterExtension&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># And it saves into the Source model.</span>
</span><span class='line'><span class="n">twitter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>To do this I created a class which I&#8217;ve randomly described as <code>TemplateModel</code>. It does exactly what is talked about above. It stores references to each child class within the parent, and upon instantiation, if it can, it returns the child class instead of the parent.</p>

<p>So without further delay, <strong><a href="http://www.pastethat.com/ta5U1">view the source for TemplateModel</a></strong>.</p>

<p>I&#8217;d be interested in hearing if anyone else has come up with their own solutions, and if you use something like this in your project how well its working for you.</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-12-29T00:00:00-08:00" pubdate data-updated="true">Dec 29<span>th</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2008/12/02/singletons-in-django">An Identity Mapper in Django (Formerly Django Singletons)</a></h1>
    <div class="entry">
        <p>As a sort of challenge to myself, I once again attempted to recreate <a href="http://code.djangoproject.com/ticket/17">ticket #17</a> as a standalone component. After a few hours, and some previous code I had written as a good guide, it seems to be working. So I&#8217;d like to announce <a href="http://github.com/dcramer/django-idmapper/tree/master">django-idmapper</a>.</p>

<p>The goal of the project is a simple plug-and-play system for integrating the identity mapper into the ORM components. It allows you it simply define as a model with a different base class (via the SharedMemoryModel class), and all queries against this model (yes even from non-singleton models) are directed through the unique instance cache.</p>

<p>In many cases, this can provide a nice decrease of memory usage, and you may even see a nice speed bonus (as we did with Curse).</p>

<p>Here is a nice and dirty quick example of a situation which would gain from this benefit:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">idmapper</span> <span class="kn">import</span> <span class="n">models</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">SharedMemoryModel</span><span class="p">):</span>
</span><span class='line'><span class="c"># We have 5 categories</span>
</span><span class='line'><span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">SharedMemoryModel</span><span class="p">):</span>
</span><span class='line'><span class="c"># And 100 articles</span>
</span><span class='line'><span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</span><span class='line'><span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

Now in a (sort of) typical query, maybe we want to show every article (or 100, which isn&#8217;t too unreasonable). We also want to show the category they are in:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">article_list</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;category&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>What we have achieved here, is only having a maximum of N (where N is the number of categories) unique instances of category in memory here. Since we only have five, this means that we only created five category instances. This gives us a savings of the time it takes to create the additional 95 category objects, as well as the memory they would have consumed.</p>

<p>Please let me know if you run in to any problems, but so far, the tests are passing :)</p>

<p><strong>Note: I&#8217;ve renamed the project due to the incorrect terminology. My apologies :)</strong></p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-12-02T00:00:00-08:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2008/12/01/spaceless-html-in-django">Spaceless HTML in Django</a></h1>
    <div class="entry">
        <p>One of the optimizations (if you want to call it that) that can be done for decreased load-time on a web page, is removing excess white space. In many of our pages at <a href="http://www.ibegin.com">iBegin</a> this saved as much as 100kb. While not every site has some of the 300kb pages that we have, it can still add up very quickly.</p>

<p>Django by default provides a <code>&#123;% spaceless %&#125;</code> tag in your templates which will allow you to achieve this effect, but we don&#8217;t use Django&#8217;s template engine (<a href="http://jinja.pocoo.org">Hooray, Jinja!</a>). The tag approach also seemed fairly inappropriate, as we just want to do it across the entire site, no matter what. Instead, we moved it into a middleware, which simply strips all whitespace (using the same method as the built-in tag) from any HTML page.</p>

<p>While this makes some pages unreadable, the time it saves downloading the page for the average user (See Steve Souders&#8217; tips) is well worth the trouble it causes a few people.</p>

<p><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Aliasing it for the sake of page size.</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">django.utils.html</span> <span class="kn">import</span> <span class="n">strip_spaces_between_tags</span> <span class="k">as</span> <span class="n">short</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">SpacelessMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'><span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span><span class='line'><span class="k">if</span> <span class="s">&#39;text/html&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]:</span>
</span><span class='line'><span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">short</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span><span class='line'><span class="k">return</span> <span class="n">response</span>
</span></code></pre></td></tr></table></div></figure>

<p>Note, that if you use page caching middleware, placing this in the appropriate place will also allow you to save space in your cache.</p>

<p>Enjoy!</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-12-01T00:00:00-08:00" pubdate data-updated="true">Dec 1<span>st</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2008/11/22/impressions-of-the-blackberry-storm">Impressions of the BlackBerry Storm</a></h1>
    <div class="entry">
        <p>I was one of the lucky few around here to get my hands on a BlackBerry Storm on Friday. Let me start by saying, I didn&#8217;t purchase (before or now) an iPhone simply because of AT&T&#8217;s coverage where my parents live. I came into this having never owned a BlackBerry before. I&#8217;ve only owned one other smartphone/pda, and it was the AT&T Tilt (HTC Kaiser). At the best of times, I was unsatisfied with the way the Tilt handled, so the Storm had a lot to prove.</p>

<p><img src="http://www.davidcramer.net/wp-content/uploads/2008/11/1223442288_blackberrystormhandson-300x202.jpg" alt="" title="1223442288_blackberrystormhandson" width="300" height="202" class="size-medium wp-image-367" /></p>

<p>So first things first, the touch display. It has similar technology to the iPhone (although, from the looks of things the iPhone is a bit more advanced). It has a &#8220;click&#8221; system, much like the touchpad on new Macbooks. You can touch the screen for a hover effect in most places, and push in to get a click. For the most part the screen works very well, and I think the solution is probably more usable than the iPhone&#8217;s simple touch. There are some issues with apps having controls which are too small, but that will probably end up getting worked out in the coming weeks and months.</p>

<p>All of the applications work just as you&#8217;d expect. They&#8217;re quality business level applications from BlackBerry. From what I understand, it&#8217;s pretty much the same as the other BlackBerry phones, some apps just have different interface controls. It includes all of the normal apps you&#8217;d expect, including your instant messengers, Facebook, Flickr, and even has a Visual Voice Mail app ($1.99/month, lame). Facebook&#8217;s app is nice, but again, you end up with controls that are hard to touch. This same issue arrises in the contact list, and browser as well.</p>

<p>The Storm also has an &#8220;Accelerometer&#8221;. You know, that trendy word that most people have no meaning of (including myself). This is the technology which handles adjusting the display when you rotate or tilt the device. It&#8217;s very cool technology, and works just like you&#8217;d expect on the iPhone. The Storm, on the other hand, does not work as well. I&#8217;ve had numerous issues (I&#8217;ve even updated to the latest released version of the platform) with it not wanting to tilt no matter what you try. I&#8217;ve ended up rebooted the device several times just to fix it (somehow it fixes itself eventually though, and the reboots are fast).</p>

<p>There are also some other issues which, while they are minor, are very annoying at times. One such issue is found in your SMS (and most likely email) controls. There&#8217;s a threaded (sort of) display for messages, and while it&#8217;s decent it&#8217;s not great. Replying to a message works like you&#8217;d expect. Select the message, and hit reply. The issue here however, is that while you&#8217;re typing your message, you sometimes will have trouble finding the &#8220;Send&#8221; button. There are two ways in which you can send: Using &#8220;Send&#8221; in the BlackBerry menu, or hiding the keyboard and hitting the button for send. Hiding the keyboard is obviously a pain, and the menu does not always function correctly. Sometimes it will not show the proper menu as if you were editing a message, but one as if you were simply viewing the threaded discussion still.</p>

<p>Overall I am very pleased with the phone. Most of the small issues are software related, and will likely be fixed very quickly. I was disappointed with the application store not being present at launch (everything I read said it was going to be), as well as the fact that Verizon seemed unprepared for the launch. I think it has a lot of potential, and should make some great consumer friendly competition for Apple. Will I keep it? I guess only time will tell :)</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-11-22T00:00:00-08:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2008/11/11/sidebar-widgets-come-to-lifestream">Sidebar Widgets Come to LifeStream</a></h1>
    <div class="entry">
        <p>Tonight I finally took the chance to finish up the sidebar widgets in LifeStream, and I think everyone who&#8217;s been waiting for them will be satisfied. The widget allows you to place one or more, using the dynamic widgets feature which is in WordPress, for any supporting themes. Each widget let&#8217;s you customize the title, the number of items to display, and an optional list of feeds.</p>

<p>The optional list of feeds is where the real power of LifeStream comes in to play. Many people use different plugins to display their Twitter updates, their Delicious updates, and whatever else they may be doing. Before now, it was somewhat difficult for the average WordPress user to do this with LifeStream, but the ability was already there. The sidebar widget will let you replace these single-use plugins, and take it a step further.</p>

<p>[gallery]</p>

<p>Now if you&#8217;re like me, and you use custom HTML for your sidebar, don&#8217;t worry! You can still gain this same functionality from a small piece of code. To do this, let&#8217;s take a look at what the dynamic sidebar widget does in Lifestream:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&lt;p&gt;lifestream_sidebar_widget(array(</span>
</span><span class='line'><span class="x">&#39;number_of_results&#39;=&gt;$options[&#39;amount&#39;],</span>
</span><span class='line'><span class="x">&#39;feed_ids&#39;=&gt;$options[&#39;feeds&#39;],</span>
</span><span class='line'><span class="x">&#39;event_total_max&#39;=&gt;-1,</span>
</span><span class='line'><span class="x">&#39;date_interval&#39;=&gt;-1,</span>
</span><span class='line'><span class="x">));</span>
</span></code></pre></td></tr></table></div></figure>
<p>We have a few options here (there are many more), which specify the number of results, an array of feed ids, the &#8220;event_total_max&#8221; (set this to 1 to hide grouped events), and date interval (-1 disables date restrictions). You can simply throw this snippet somewhere in your sidebar, and you&#8217;ll gain the same effect as you would using the dynamic sidebar.</p>

<p>Create a box for just your delicious links, just your tweets, or maybe combine all of your bookmarking services into their own widget. The power is yours :)</p>

<p><strong>Update:</strong> I iterate so quickly, that 0.81 is now available with shiny new options.</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-11-11T00:00:00-08:00" pubdate data-updated="true">Nov 11<span>th</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2008/11/07/tips-for-scaling-a-web-app">Tips for Scaling a Web App</a></h1>
    <div class="entry">
        <p>As many of you know, I&#8217;ve been working on things over at <a href="http://www.ibegin.com/">iBegin</a> for the past 6 months. One of the things we did was a complete rewrite of our platform which includes a local business listings directory. While doing this, I had the goal in mind to make it as scalable as possible, and keep the caching as simple as possible. I wanted to give everyone a brief rundown on our philosophy and how we&#8217;ve done that.</p>

<p>The first, and most important thing we&#8217;ve done, is make every page cachable that doesn&#8217;t vary per-user. This is almost every single page on the website, and the only one&#8217;s that aren&#8217;t ready to be cached, are pages like user settings. We also wanted these pages to be cached exactly the same no matter what kind of user was accessing them. For us the best solution in this case, was to draw in common things with JavaScript, such as &#8220;Logged in as David&#8221;, or notifications.</p>

<p>There are two main components in handling this. A JavaScript component, and a backend view. So let&#8217;s show a bit of code, for how we handle this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">userData</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">initializeUserControls</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/account/jsdata/&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">new</span> <span class="nx">Ajax</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">onComplete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// set userData to the value of the JSON result</span>
</span><span class='line'>            <span class="nx">userData</span> <span class="o">=</span> <span class="nx">Json</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">resp</span> <span class="o">||</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">controls</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;accountNav&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">controls</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">userData</span><span class="p">.</span><span class="nx">is_authenticated</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// If they are logged in, show a logout link</span>
</span><span class='line'>                <span class="kd">var</span> <span class="nx">li</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>                    <span class="s1">&#39;class&#39;</span><span class="o">:</span> <span class="s1">&#39;last&#39;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;navLogout&#39;</span>
</span><span class='line'>                <span class="p">});</span>
</span><span class='line'>                <span class="nx">li</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>                    <span class="s1">&#39;href&#39;</span><span class="o">:</span> <span class="nx">BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/account/logout/&#39;</span>
</span><span class='line'>                <span class="p">}).</span><span class="nx">setText</span><span class="p">(</span><span class="s1">&#39;Logout&#39;</span><span class="p">));</span>
</span><span class='line'>                <span class="nx">controls</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">li</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Otherwise, show a login link</span>
</span><span class='line'>                <span class="kd">var</span> <span class="nx">li</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;navLogin&#39;</span><span class="p">});</span>
</span><span class='line'>                <span class="nx">li</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>                    <span class="s1">&#39;href&#39;</span><span class="o">:</span> <span class="nx">BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/account/login/&#39;</span>
</span><span class='line'>                <span class="p">}).</span><span class="nx">setText</span><span class="p">(</span><span class="s1">&#39;Login&#39;</span><span class="p">));</span>
</span><span class='line'>                <span class="nx">controls</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">li</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;get&#39;</span>
</span><span class='line'>    <span class="p">}).</span><span class="nx">request</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;domready&#39;</span><span class="p">,</span> <span class="nx">initializeUserControls</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

As you can see here, on page load, we initiate an AJAX request to /account/jsdata/. This backend then sends us a JSON encoded dictionary of a few various things:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span><span class="s2">&quot;is_authenticated&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="o">:</span> <span class="s2">&quot;dcramer&quot;</span><span class="p">,</span> <span class="s2">&quot;messages&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;user_id&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

And outputting this data is even easier:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="nd">@never_cache</span>
</span><span class='line'><span class="k">def</span> <span class="nf">js_user</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class='line'>    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;is_authenticated&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">(),</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;notices&#39;</span><span class="p">):</span>
</span><span class='line'>        <span class="n">context</span><span class="p">[</span><span class="s">&#39;messages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">get_and_clear</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;is_authenticated&#39;</span><span class="p">]:</span>
</span><span class='line'>        <span class="n">context</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
</span><span class='line'>        <span class="n">context</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

Now we have handled making nearly every page on our site cachable, whether it&#8217;s done in memcache, or a reverse proxy.

Our next task is making the database scale. A good 40% of the development time is spent in designing the platform, and most of this relies around the database. We have enormous amounts of denormalization hooks, and very specific indexing. It&#8217;s very common in our database, to store the data from a typical foreign key in the same table which it is referencing.

To give a clear example on where this is beneficial, let&#8217;s take a look at our directory links:

<pre>
http://www.ibegin.com/directory/us/new-york/new-york/acura-of-manhattan-662-11th-ave/
</pre>

Obviously, we have a lot of information in the URL. The typical schema here is that a business has a foreign key to a city, which has a foreign key to a state, which has a foreign key to a country. Ouch! To avoid the relational problems which this schema would create, we store the country, state, and city, all as foreign key references within each actual listing. Even more so, we store the slugs for each one as well.

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">BusinessMeta</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class='line'>    <span class="n">country</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Country</span><span class="p">)</span>
</span><span class='line'>    <span class="n">country_slug</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SlugField</span><span class="p">()</span>
</span><span class='line'>    <span class="n">state</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span><span class='line'>    <span class="n">state_slug</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SlugField</span><span class="p">()</span>
</span><span class='line'>    <span class="n">city</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">City</span><span class="p">)</span>
</span><span class='line'>    <span class="n">city_slug</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SlugField</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s">&#39;city&#39;</span><span class="p">):</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="o">.</span><span class="n">country</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">country_slug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">slug</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="o">.</span><span class="n">state</span>
</span></code></pre></td></tr></table></div></figure>

<p>As you can see, we hook the save method here to ensure that if our city is changed, we update the related fields, country, and state. Please note that <strong>has_changed()</strong> is not part of the Django core.</p>

<p>In this same example, a typical Django application might have been built with singular indexes on country, state, and city, as they are all Foreign Key references and that is the standard in Django. This is one of the first things you should be looking at when optimization your database. In our situation, we could look up a business listing by the country, by the state, or by the city, but it&#8217;s always the country, the country and state, or the country, state, and city, so we can optimize our index here:</p>

<pre>INDEX (`country`, `state`, `city`)</pre>

<p>Since indexes work left to right, this index will handle all three of the above queries, and on our dataset of 12 million records, takes 1 or 2 milliseconds to return a typical dataset.</p>

<p>These are just a few of the tricks we use to optimize things at iBegin, but they are some of the most critical. We also use composite primary keys to handle a semi-shared dataset (we have around 13 million businesses listed), a lot of save triggers such as seen above, and many summary tables. However, we have not modified Django&#8217;s core for any performance optimizations and we are able to do 10-20ms requests without a problem.</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-11-07T00:00:00-08:00" pubdate data-updated="true">Nov 7<span>th</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2008/10/17/how-things-have-changed">How Things Have Changed</a></h1>
    <div class="entry">
        <p>The last few weeks have had a lot of work related to SEO/SEM both at <a href="http://www.ibegin.com/">iBegin</a> and on random sites of my own, like <a href="http://www.nibbits.com/">Nibbits</a>. On iBegin we&#8217;ve been tweaking our robots handling, meta descriptions, and titles, all to try and get the most out of Google. We&#8217;ve also found we&#8217;ve needed to do much more than that due to some quirks with Google. At Nibbits, it&#8217;s some of the same stuff, but less specific. I use it as more of a benchmark for how things are improving.</p>

<p>So, what have we done?</p>

<p><strong>Change temporary redirects to permanent</strong></p>

<p>One of the first headaches I&#8217;ve had recently, was the discovery that Google doesn&#8217;t really understand, or care, about how your redirects work. It wants you to have unique pages, and not references to those pages. On iBegin, to avoid extra query overhead, we initially had a URL which was /go/slice_ID/key_ID/ for forwarding to a businesses full URL. This was running your standard 302 redirect, which is the common status code for a temporary redirect.</p>

<p>To sum it up, Google complained about these pages being copies of the pages they&#8217;re actually redirecting too (rather than references), so we ended up replacing all indexable redirects with permanent redirects. Anywhere possible, we added more denormalization hooks just to avoid these kind of redirects all together.</p>

<p>Some relevant code:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">ChangeRedirectsMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Because Google sees a temporary redirect as a copy of the page,</span>
</span><span class='line'><span class="sd">    instead of a reference, we must force it to be a permanent redirect.&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="s">&#39;googlebot&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s">&#39;HTTP_USER_AGENT&#39;</span><span class="p">]</span> \
</span><span class='line'>        <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">302</span><span class="p">,</span> <span class="mi">307</span><span class="p">):</span>
</span><span class='line'>            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">301</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">response</span>
</span></code></pre></td></tr></table></div></figure>

<strong>Holy shit sitemaps work</strong>

One of the many things introduced over the last couple of years, were the Google sitemaps. I myself had never implemented these on a website until recently simply due to the fact that I never noticed an indexing problem. Let me tell you this has been one of the worst decisions I have ever made. They&#8217;ve been great for keeping iBegin&#8217;s millions of businesses in Google&#8217;s index, as well as immediately adding almost all of Nibbit&#8217;s pages to Google.

For a rough example, Nibbits was up for about 3 months, and had about 3,000 pages in Google. I added sitemaps to it and within a week it jumped to 40,000 pages and growing.

Django providing a nice contrib application for working with sitemaps, but it&#8217;s not quite good enough for all use-cases, like Yahoo crawling 200 sitemaps all at once that aren&#8217;t pre-generated. We ended up rolling out or own <code>generate_sitemaps</code> management command, which writes them to disk. At the moment we haven&#8217;t implemented any code to add or update changed entries.

Here&#8217;s a rough implementation (a bit old) of how ours was working. As you will see, I attempted to use generators to avoid the very scary amount of memory which was being used to generate these.

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">SitemapGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">site</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'>        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">default</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">attr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">attr</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_urls_from_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
</span><span class='line'>        <span class="n">current_site</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span>
</span><span class='line'>        <span class="n">page</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">validate_number</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</span><span class='line'>        <span class="n">bottom</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">site</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">per_page</span>
</span><span class='line'>        <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">+</span> <span class="n">site</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">per_page</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">top</span> <span class="o">+</span> <span class="n">site</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">orphans</span> <span class="o">&gt;=</span> <span class="n">site</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
</span><span class='line'>            <span class="n">top</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">object_list</span><span class="p">[</span><span class="n">bottom</span><span class="p">:</span><span class="n">top</span><span class="p">]:</span>
</span><span class='line'>            <span class="n">loc</span> <span class="o">=</span> <span class="s">&quot;http://</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="s">&#39;location&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
</span><span class='line'>            <span class="n">url_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="s">&#39;location&#39;</span><span class="p">:</span>   <span class="n">loc</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&#39;lastmod&#39;</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="s">&#39;lastmod&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
</span><span class='line'>                <span class="s">&#39;changefreq&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="s">&#39;changefreq&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
</span><span class='line'>                <span class="s">&#39;priority&#39;</span><span class="p">:</span>   <span class="bp">self</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="s">&#39;priority&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">yield</span> <span class="n">url_info</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">yield</span> <span class="s">&quot;&lt;?xml version=</span><span class="se">\&quot;</span><span class="s">1.0</span><span class="se">\&quot;</span><span class="s"> encoding=</span><span class="se">\&quot;</span><span class="s">UTF-8</span><span class="se">\&quot;</span><span class="s">?&gt;&quot;</span>
</span><span class='line'>        <span class="k">yield</span> <span class="s">&quot;&lt;urlset xmlns=</span><span class="se">\&quot;</span><span class="s">http://www.sitemaps.org/schemas/sitemap/0.9</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span>
</span><span class='line'>            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">site</span><span class="p">):</span>
</span><span class='line'>                <span class="n">site</span> <span class="o">=</span> <span class="n">site</span><span class="p">()</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_urls_from_site</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">):</span>
</span><span class='line'>                <span class="k">yield</span> <span class="s">&quot;&lt;url&gt;&lt;loc&gt;</span><span class="si">%s</span><span class="s">&lt;/loc&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">],)</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">url</span><span class="p">[</span><span class="s">&#39;lastmod&#39;</span><span class="p">]:</span>
</span><span class='line'>                    <span class="k">yield</span> <span class="s">&quot;&lt;lastmod&gt;</span><span class="si">%s</span><span class="s">&lt;/lastmod&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">[</span><span class="s">&#39;lastmod&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">),)</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">url</span><span class="p">[</span><span class="s">&#39;changefreq&#39;</span><span class="p">]:</span>
</span><span class='line'>                    <span class="k">yield</span> <span class="s">&quot;&lt;changefreq&gt;</span><span class="si">%s</span><span class="s">&lt;/changefreq&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">[</span><span class="s">&#39;changefreq&#39;</span><span class="p">],)</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">url</span><span class="p">[</span><span class="s">&#39;priority&#39;</span><span class="p">]:</span>
</span><span class='line'>                    <span class="k">yield</span> <span class="s">&quot;&lt;priority&gt;</span><span class="si">%s</span><span class="s">&lt;/priority&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">[</span><span class="s">&#39;priority&#39;</span><span class="p">],)</span>
</span><span class='line'>                <span class="k">yield</span> <span class="s">&quot;&lt;/url&gt;&quot;</span>
</span><span class='line'>        <span class="k">except</span> <span class="n">EmptyPage</span><span class="p">:</span>
</span><span class='line'>            <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s">&quot;Page </span><span class="si">%s</span><span class="s"> empty&quot;</span> <span class="o">%</span> <span class="n">page</span><span class="p">)</span>
</span><span class='line'>        <span class="k">except</span> <span class="n">PageNotAnInteger</span><span class="p">:</span>
</span><span class='line'>            <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s">&quot;No page &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">page</span><span class="p">)</span>
</span><span class='line'>        <span class="k">yield</span> <span class="s">&quot;&lt;/urlset&gt;&quot;</span>
</span></code></pre></td></tr></table></div></figure>

<p><strong>Unique &lt;title&gt;&#8217;s</strong></p>

<p>One of the many things Google has been whining about (via webmaster tools) was the fact that some of our pages shared the same titles. I&#8217;m unsure yet how this is really affecting the weighting in Google, but it&#8217;s a good thing to note none the less.</p>

<p><strong>Robots and nofollow</strong></p>

<p>Another one of the many things I had not been doing until earlier this year, was using robots.txt and <code>rel="nofollow"</code> in order to prevent Google from distributing it&#8217;s weight to pages which you don&#8217;t really care about. These could be anything from a contact form, to an entire section of your website. This can really help you achieve maximum efficiency for weighting pages which really matter to you in Google, but should also be used cautiously.</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-10-17T00:00:00-07:00" pubdate data-updated="true">Oct 17<span>th</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2008/10/17/blogrolls-and-friendships">Blogrolls and Friendships</a></h1>
    <div class="entry">
        <p>I&#8217;ve been thinking about an interesting concept, and potential project lately. Most blogs have a &#8220;Blogroll&#8221;, or a list of other blogs that are typically friends or colleagues. A lot of these bloggers also subscribe to those blogs with RSS readers, or whatever tool suits them. My concept was to socialize this aspect of the blogging atmosphere.</p>

<p>It would work much like your Facebook friendships. You add a friend (in this case, a website), and are notified when updates happen. It could automatically find RSS feeds on most websites (all the major blogging platforms, which is enough to matter), and would even integrate with my <a href="/my-projects/lifestream">lifestream plugin</a>. It could then generate an RSS feed of what&#8217;s going on with all of your friends, including all of their lifestreamed information, and posts from their blogs, without you having to do anything beyond adding &#8220;Friends&#8221; from your blogroll.</p>

<p>Anyways, I&#8217;m posting this here to open it up to any feedback out there. I think it&#8217;s a pretty cool idea, and I&#8217;m curious as to how many others would find it useful.</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-10-17T00:00:00-07:00" pubdate data-updated="true">Oct 17<span>th</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>

<nav id="pagenavi">
    
        <a href="/blog/page/5/" class="prev">Prev</a>
    
    
        <a href="/blog/page/7/" class="next">Next</a>
    
    <a href="/blog/archives" class="center">Blog Archives</a>
</nav></div>
	<footer class="inner">Copyright &copy; 2012 David Cramer &mdash; Need exceptional error logging? Try out <a href="https://www.getsentry.com">Sentry</a></footer>
	<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'davidcramer';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>
</html>