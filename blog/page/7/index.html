
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>David Cramer's Blog</title>
  <meta name="author" content="David Cramer">

  
  <meta name="description" content="Recently I&#8217;ve been incorporating alternative techniques to Captcha to prevent automated form submission on websites, which is typically spam, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://justcramer.com/blog/page/7">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/DavidCramernet" rel="alternate" title="David Cramer's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">David Cramer's Blog</a></h1>
  
    <h2>Python at Scale.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/DavidCramernet" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:justcramer.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives/">Archives</a></li>
  <li><a href="/resume/">Resume</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/09/11/dealing-with-automated-form-submission-spam">Dealing With Automated Form Submission (Spam)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-11T00:00:00-07:00" pubdate data-updated="true">Sep 11<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I&#8217;ve been incorporating alternative techniques to Captcha to prevent automated form submission on websites, which is typically spam, or something else you don&#8217;t want happening. I added our routines to the new iBegin&#8217;s submission system today, and thought that I&#8217;d share with the world what we&#8217;re doing. I&#8217;m also curious as to what everyone else does to solve these problems, without burdening the user.</p>

<p>On Curse we implemented a middleware, which on any POST request, would confirm that a user had filled in a Captcha box within the last N hours, or had verified themselves as a human being in some other fashion (a text message was our method).</p>

<p>Now in iBegin, and my websites, we use two different methods to prevent spam. One is the <em>honeypot</em> method, which insert a text field with no value. This field is hidden with CSS, and if a value is passed on submission we assume that it&#8217;s a bot or something else trying to submit the form.</p>

<p>The second method, requires the user have JavaScript enabled, but is very similar. We insert another text field, and set the value to &#8216;hello&#8217;. This field is also hidden with CSS, and on submission, we verify the value is still &#8216;hello&#8217;.</p>

<p>If either of this fail, the form will throw a validation error, and of course log the attempt. So far, in all of my use-cases, it has worked very well, and the only &#8220;spam&#8221; I&#8217;ve seen are real users doing it themselves.</p>

<p>So for a more technical look, here&#8217;s a sample of the code from our submission page for business listings:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;p&gt;&lt;div</span> <span class="na">style=</span><span class="s">&quot;display:none;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>These fields are present to prevent automated submission systems. If you see it, please do not fill in a value.
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="kd">var</span> <span class="nx">varname</span><span class="o">=</span><span class="s1">&#39;nospam1&#39;</span><span class="p">;</span><span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;&lt;inp&#39;</span><span class="o">+</span><span class="s1">&#39;ut name=&quot;&#39;</span><span class="o">+</span><span class="nx">varname</span><span class="o">+</span><span class="s1">&#39;&quot; type=&quot;text&quot; value=&quot;1&quot;/&gt;&#39;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;nospam2&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

And our Django form validation:
<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
</span><span class='line'><span class="n">form</span> <span class="o">=</span> <span class="n">BusinessForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="n">hidden</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;nospam1&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;hello&#39;</span><span class="p">:</span>
</span><span class='line'><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;`nospam1` value not set properly on form submission form </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;REMOTE_ADDR&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;noip&gt;&#39;</span><span class="p">),))</span>
</span><span class='line'><span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s">&#39;__all__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;There was an unknown error submitting your request.&#39;</span>
</span><span class='line'><span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;nospam2&#39;</span><span class="p">):</span>
</span><span class='line'><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;`nospam2` value set on form submission form </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;REMOTE_ADDR&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;noip&gt;&#39;</span><span class="p">),))</span>
</span><span class='line'><span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s">&#39;__all__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;There was an unknown error submitting your request.&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/09/09/djangocon-2008-is-over">DjangoCon 2008 Is Over</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-09T00:00:00-07:00" pubdate data-updated="true">Sep 9<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Just got back home this evening from DjangoCon. It was really a lot of fun. It&#8217;s always great to be able to put a face to a name, or a 100 faces to names, in this case. I met a lot of really cool people, and some of the presentations were fantastic (especially Cal Henderson&#8217;s).</p>

<p>My presentation went fairly good. I was pretty nervous so I went to my slides way too fast and didn&#8217;t go into the details like I had planned out. I will know next time to make more slides, and to have more notes on what I want to talk about. For anyone who is interested, you can view the slides on <a href="http://www.slideshare.net/zeeg/django-con-high-performance-django-presentation/1?from=email&type=comment_onslide&subtype=slideshow">SlideShare</a>.</p>

<p>After hearing a lot of the opinions from people, I think the core Django team is going to take into serious consideration some of the feature requests I&#8217;ve wanted for a while (mostly database related). At least a good 5-10% of the speakers brought up singletons (ticket #17), and several others brought up denormalization and database clustering. I was really glad to see I wasn&#8217;t as crazy as I had thought, and the only person who really needed these features.</p>

<p>A big thanks to everyone who made DjangoCon &#8216;08 possible, hope to be able to go to the next one as well :)</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/09/07/django-debug-toolbar">Django Debug Toolbar</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-07T00:00:00-07:00" pubdate data-updated="true">Sep 7<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>After the presentation yesterday evening, and Cal Anderson showing Pownce&#8217;s debug toolbar for a moment, it seemed like a great idea to create a pluggable out of it. It turned out I wasn&#8217;t the only one with this idea.</p>

<p>I ended up creating a few &#8220;panels&#8221; inside of an overlay toolbar, which showed things like SQL queries, profile output, and cache hits/misses. At the same time, <a href="http://www.twitter.com/robhudson">Rob Hudson</a> had created a pluggable framework for handling these &#8220;panels&#8221;. After somehow running into each other in the lounge at the hotel, we successfully managed to add my panels to the <a href="http://github.com/dcramer/django-debug-toolbar/tree/master">django-debug-toolbar project</a>.</p>

<p>The project is pretty neat. It&#8217;s quite simple, and allows you to have access to some very nice debug/profiling information as long as you are listed in INTERNAL_IPS. It&#8217;s also extendable via panel system, which Rob created.</p>

<p>I&#8217;m not sure when an &#8220;official&#8221; release will be made, but there&#8217;s still a few things planned, both by myself, and by Rob, which will make this a killer app to use.</p>

<p>For now, here&#8217;s some screens&#8230;</p>

<p>(We haven&#8217;t implemented a profile module solution completely yet into the panel system)</p>

<p>[gallery]</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/09/06/high-performance-django">High Performance Django</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-06T00:00:00-07:00" pubdate data-updated="true">Sep 6<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Below you will find resources from my presentation on High Performance Django.</p>

<ul><br><li><a href="http://www.slideshare.net/zeeg/django-con-high-performance-django-presentation/">Slides</a></li><br><li><a href="http://www.pastethat.com/dlnsr">Profiling Middleware</a></li><br><li>Template Engine Benchmarks: <a href="http://dev.pocoo.org/hg/jinja2-main/file/tip/examples/rwbench/">Real-world Example</a>, <a href="http://dev.pocoo.org/hg/jinja2-main/file/80ed3eaab7d3/examples/basic/">Benchmark Testcase</a></li><br></ul></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/08/25/wordpress-lifestream-updates">WordPress LifeStream Plugin Updates</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-25T00:00:00-07:00" pubdate data-updated="true">Aug 25<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This weekend I took the opportunity to implement a bunch of changes, and fixes, into the wp-lifestream plugin which I created. It got a quick overhaul on the extensibility end, allowing you to do much more with complex feeds. To demonstrate the power, I went ahead and built the much-requested Pandora feed plugin.</p>

<p>The plugin itself, pulls from three different feeds, and displays different labels based on which feed the data comes from. The new feed format allows you to store a key, which specifies the a sort-of sub-feed within the feed. The changes also allow you to make the labels on all feeds dynamic, by overriding two new functions: <code>get_label_single()</code> and <code>get_label_plural()</code>.</p>

<p>I also went ahead and moved the LifeStream administration into its own tab, instead of trying to integrate my CSS into WordPress. This allows it much better integration with custom administration themes.</p>

<p>You will find that the links to feed sites are now replaced with links to your profiles on those sites (on most feeds). This will make it easier for your visitors to interact with you on the many social networks out there which exist.</p>

<p>And finally among the changes, are more internal changes geared towards hackers who want to customize the output of their feed. The function <code>lifestream_get_events()</code> was added, which accepts the same parameters as the default <code>lifestream()</code> function, but instead returns an array of Event instances. This allows you to do anything from putting your lifestream in a custom sidebar template, to sticking your recent tweets on the homepage.</p>

<p>Among the TODO, when I get more time, is support for WPMU, and as always, more feeds.</p>

<p>If you think there&#8217;s something that would make a good addition, feel free to let me know. Either drop me an <a href="mailto:dcramer@gmail.com">email</a> or post a comment on the <a href="/my-projects/lifestream">project page</a>.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/08/23/logging-in-with-email-addresses-in-django">Logging in With Email Addresses in Django</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-23T00:00:00-07:00" pubdate data-updated="true">Aug 23<span>rd</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the tasks that seems to come up every single project we do, is changing the auth backend to accept email addresses. Since it&#8217;s such a common task for us, it can&#8217;t be that rare to want this functionality. So, here&#8217;s a quick and simply backend which accomplishes this, using the built-in <em>django.contrib.auth</em> module.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">EmailOrUsernameModelBackend</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'><span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class='line'><span class="k">if</span> <span class="s">&#39;@&#39;</span> <span class="ow">in</span> <span class="n">username</span><span class="p">:</span>
</span><span class='line'><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>
</span><span class='line'><span class="k">else</span><span class="p">:</span>
</span><span class='line'><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class='line'><span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span><span class='line'><span class="k">return</span> <span class="n">user</span>
</span><span class='line'><span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
</span><span class='line'><span class="k">return</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'><span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span class='line'><span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
</span><span class='line'><span class="k">return</span> <span class="bp">None</span>
</span></code></pre></td></tr></table></div></figure>

Then in your settings:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">AUTHENTICATION_BACKENDS</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'><span class="s">&#39;myproject.accounts.backends.EmailOrUsernameModelBackend&#39;</span><span class="p">,</span>
</span><span class='line'><span class="s">&#39;django.contrib.auth.backends.ModelBackend&#39;</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/08/13/a-better-paginator-in-django">A Better Paginator in Django</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-13T00:00:00-07:00" pubdate data-updated="true">Aug 13<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the tasks that I seem to repeatedly do across multiple projects, is extend the built-in paginator from Django. The built-in is fairly nice, but it&#8217;s quite honestly extremely confusing as you have to pass around a paginator instance as well as a paginator.page() instance in order to get useful pagination inside of a template.</p>

<p>After the Nth time of someone coming up with questions about the paginator, and seeing Brian Rosner&#8217;s not-very-smart &#8220;smart_page_range&#8221; code (his words, not mine!), I figured it might be useful to throw this out to the public.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">django.core.paginator</span> <span class="kn">import</span> <span class="n">QuerySetPaginator</span><span class="p">,</span> <span class="n">InvalidPage</span>
</span><span class='line'>
</span><span class='line'><span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;BetterQuerySetPaginator&#39;</span><span class="p">,</span> <span class="s">&#39;InvalidPage&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">BetterQuerySetPaginator</span><span class="p">(</span><span class="n">QuerySetPaginator</span><span class="p">):</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">An enhanced version of the QuerySetPaginator.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">&gt;&gt;&gt; my_objects = BetterQuerySetPaginator(queryset, 25)</span>
</span><span class='line'><span class="sd">&gt;&gt;&gt; page = 1</span>
</span><span class='line'><span class="sd">&gt;&gt;&gt; context = {</span>
</span><span class='line'><span class="sd">&gt;&gt;&gt;     &#39;my_objects&#39;: my_objects.get_context(page),</span>
</span><span class='line'><span class="sd">&gt;&gt;&gt; }</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="k">def</span> <span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">range_gap</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'><span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</span><span class='line'><span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">),</span> <span class="n">exc</span><span class="p">:</span>
</span><span class='line'><span class="k">raise</span> <span class="n">InvalidPage</span><span class="p">,</span> <span class="n">exc</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span class='line'><span class="n">start</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="n">range_gap</span>
</span><span class='line'><span class="k">else</span><span class="p">:</span>
</span><span class='line'><span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_pages</span><span class="o">-</span><span class="n">range_gap</span><span class="p">:</span>
</span><span class='line'><span class="n">end</span> <span class="o">=</span> <span class="n">page</span><span class="o">+</span><span class="n">range_gap</span><span class="o">+</span><span class="mi">1</span>
</span><span class='line'><span class="k">else</span><span class="p">:</span>
</span><span class='line'><span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_pages</span><span class="o">+</span><span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="n">paginator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'><span class="s">&#39;page_range&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span>
</span><span class='line'><span class="s">&#39;objects&#39;</span><span class="p">:</span> <span class="n">paginator</span><span class="o">.</span><span class="n">object_list</span><span class="p">,</span>
</span><span class='line'><span class="s">&#39;num_pages&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_pages</span><span class="p">,</span>
</span><span class='line'><span class="s">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
</span><span class='line'><span class="s">&#39;has_previous&#39;</span><span class="p">:</span> <span class="n">paginator</span><span class="o">.</span><span class="n">has_previous</span><span class="p">(),</span>
</span><span class='line'><span class="s">&#39;has_next&#39;</span><span class="p">:</span> <span class="n">paginator</span><span class="o">.</span><span class="n">has_next</span><span class="p">(),</span>
</span><span class='line'><span class="s">&#39;previous_page&#39;</span><span class="p">:</span> <span class="n">paginator</span><span class="o">.</span><span class="n">previous_page_number</span><span class="p">(),</span>
</span><span class='line'><span class="s">&#39;next_page&#39;</span><span class="p">:</span> <span class="n">paginator</span><span class="o">.</span><span class="n">next_page_number</span><span class="p">(),</span>
</span><span class='line'><span class="s">&#39;is_first&#39;</span><span class="p">:</span> <span class="n">page</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'><span class="s">&#39;is_last&#39;</span><span class="p">:</span> <span class="n">page</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_pages</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">return</span> <span class="n">context</span>
</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/08/12/updating-to-mysql-51-from-a-fink-installation">Updating to MySQL 5.1 From a Fink Installation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-12T00:00:00-07:00" pubdate data-updated="true">Aug 12<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I went through the fun task of updating my local MySQL installation to 5.1 in order to try out then new partitioning. The challenge here, was that I wanted to keep everything for fink in order (the same paths, and for the most part, the same options).</p>

<p>So first, you need to download the <a href="http://dev.mysql.com/downloads/mysql/5.1.html#source">source</a> for MySQL 5.1. Don&#8217;t get the Mac OS installer or tar!</p>

<p>Untar this to wherever is convenient, and pop open a terminal. Now we need to run configure with the crazy amount of options there are to make it work with fink. One issue I did find while doing this is that it didn&#8217;t want to detect fink&#8217;s readline, so I ended up configuring it with the included readline.</p>

<pre><br>./configure --enable-assembler --with-extra-charsets=complex --enable-thread-safe-client --with-big-tables--with-innodb --with-archive-storage-engine --with-big-tables --with-embedded-server --enable-local-infile --disable-dependency-tracking --with-mysqld-user=mysql --mandir=/sw/share/man --infodir=/sw/share/info --localstatedir=/sw/var/mysql --libexecdir=/sw/sbin --sysconfdir=/sw/etc --bindir=/sw/bin --datadir=/sw/share/mysql --includedir=/sw/include/mysql --libdir=/sw/lib/mysql --with-readline --with-partition && make<br></pre>

<p>This does *not* include all of the same options. I removed some of the storage engines which I will never use, including ndb, blackhole, federated, and the yassl extension which was deprecated. This also does not include ssl.</p>

<p>Now go grab some lunch, the configure is going to take a good 30 minutes depending on how powerful your Mac is.</p>

<p>The rest is simply your standard <code>sudo make install</code>.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/08/08/custom-fields-in-django">Custom Fields in Django</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-08T00:00:00-07:00" pubdate data-updated="true">Aug 8<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was helping someone today in the <a href="irc://irc.freenode.net/django">Django IRC channel</a> and the question came across about storing a denormalized data set in a single field. Typically I do such things by either serializing the data, or by separating the values with a token (comma for example).</p>

<p>Django has a built-in field type for <a href="http://www.djangoproject.com/documentation/model-api/#commaseparatedintegerfield">CommaSeparatedIntegerField</a>, but most of the time I&#8217;m storing strings, as I already have the integers available elsewhere. As I began to answer the person&#8217;s question by giving him an example of usage of serialization + custom properties, until I realized that it would be much easier to just write this as a Field subclass.</p>

<p>So I quickly did, and replaced a few lines of repetitive code with two new field classes in our source:</p>

<p><strong>Update:</strong> There were some issues with my understanding of how the metaclass was working. I&#8217;ve corrected the code and it should function properly now.</p>

<p><h3>SerializedDataField</h3></p>

<p>This field is typically used to store raw data, such as a dictionary, or a list of items, or could even be used for more complex objects.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="kn">as</span> <span class="nn">pickle</span>
</span><span class='line'><span class="k">except</span><span class="p">:</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">pickle</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">base64</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SerializedDataField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Because Django for some reason feels its needed to repeatedly call</span>
</span><span class='line'><span class="sd">    to_python even after it&#39;s been converted this does not support strings.&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SubfieldBase</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span> <span class="k">return</span> <span class="n">value</span>
</span><span class='line'>        <span class="n">value</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">value</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_db_prep_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

<h3>SeparatedValuesField</h3>

An alternative to the CommaSeparatedIntegerField, it allows you to store any separated values. You can also optionally specify a <code>token</code> parameter.

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SeparatedValuesField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">):</span>
</span><span class='line'>    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SubfieldBase</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;token&#39;</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">super</span><span class="p">(</span><span class="n">SeparatedValuesField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span> <span class="k">return</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">value</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_db_prep_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span> <span class="k">return</span>
</span><span class='line'>        <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">value_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span><span class='line'>        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_val_from_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_prep_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/08/02/more-updates-to-django-sphinx">More Updates to Django-sphinx</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-02T00:00:00-07:00" pubdate data-updated="true">Aug 2<span>nd</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was working on our search for the new <a href="http://www.ibegin.com/">iBegin</a> today, which utilizes Sphinx, Django, and obviously, <a href="http://code.google.com/p/django-sphinx/">django-sphinx</a>. Being the person who hates doing tedious work, I found a few issues in the newly done configuration generation.</p>

<ul><li>Errors hardcore in 0.98</li><li>It wasn&#8217;t generating attributes for floats (latitude/longitude)</li><li>Didn&#8217;t work with custom index names</li></ul>

<p>So tonight, after a few hours, I&#8217;ve refactored a good chunk of the manager code, as well as the config generation code. Among the updates include:</p>

<ul><li>There is now an included api for 0.98, as well as proper configuration generation. To use it simply do the following in <code>settings.py</code>:<pre>SPHINX_API_VERSION = 0x113</pre><br></li><li>The api support is very flexible for future versions (just requires override templates and inclusion of the api).</li><li>The generation command via manage.py now properly generates sample config for ANY model with Sphinx attached to it.</li><li>You can now pass the <code>UpdateAttributes()</code> command via <code>instance.sphinx.update(kwargs)</code>.</li></ul>

<p>As always, grab the code over at <a href="http://code.google.com/p/django-sphinx/">Google</a> and make sure to subscribe to the <a href="http://groups.google.com/group/django-sphinx">Google group</a> to be spammed with updates.</p></div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/8/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/6/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/04/08/using-arrays-as-materialized-paths-in-postgres">Using Arrays as Materialized Paths in Postgres</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/10/scaling-schema-changes">Scaling Schema Changes</a>
      </li>
    
      <li class="post">
        <a href="/2011/08/05/extending-django-nose">Integrating Django with Nose at DISQUS</a>
      </li>
    
      <li class="post">
        <a href="/2011/07/20/python-and-os-x-lion">Python and OS X Lion</a>
      </li>
    
      <li class="post">
        <a href="/2011/06/24/europython">EuroPython</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/dcramer">@dcramer</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'dcramer',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("zeeg", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/zeeg" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @zeeg</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - David Cramer -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'davidcramer';
      
        
        // var disqus_developer = 1;
        
            var disqus_identifier = ''
        
        var disqus_url = 'http://justcramer.com/blog/page/7/index.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4f0ffdc0844d521595000001');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>

</body>
</html>
