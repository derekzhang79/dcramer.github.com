
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>David Cramer's Blog</title>
    <meta name="author" content="David Cramer">

    
    <meta name="description" content="Improving GZipMiddleware in Django One issue we had come up over at iBegin lately, is the fact that GZipMiddleware tries to encode ALL responses ( &hellip;">
    
    <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=1">

    <link href="http://feeds.feedburner.com/DavidCramernet" rel="alternate" title="David Cramer's Blog" type="application/atom+xml">
    <link rel="canonical" href="">
    <link href="/favicon.png" rel="shortcut icon">
    <link href="/stylesheets/screen.css?1" media="screen, projection" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4f0ffdc0844d521595000001');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
    

</head>

<body>
	<header class="inner"><h1><a href="/">David Cramer's Blog</a></h1>
<nav class="menu"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<div class="right">
	<form class="search right" action="http://google.com/search" method="get">
		<input class="left" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:justcramer.com">
	</form>
	<div class="social right">
		
		
		
		<a class="twitter" href="http://twitter.com/zeeg" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/dcramer" title="GitHub">GitHub</a>
		
		
		
		<a class="rss" href="http://feeds.feedburner.com/DavidCramernet" title="RSS">RSS</a>
		
	</div>
</div>

</header>
	<div id="content" class="inner">


    <article class="post">
    <h1 class="title"><a href="/2009/04/17/improving-gzipmiddleware-in-django">Improving GZipMiddleware in Django</a></h1>
    <div class="entry">
        <p>One issue we had come up over at iBegin lately, is the fact that GZipMiddleware tries to encode ALL responses (with a few minor exceptions). In our cases, we sometimes stream actual binary files over the response. Doing this with the standard middleware causes a unicode error as it&#8217;s trying to encode all of the information before gzipping it.</p>

<p>So to fix this, we simply created a slightly improved middleware to handle the content types a bit better:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">django.middleware.gzip</span> <span class="kn">import</span> <span class="n">GZipMiddleware</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">ImprovedGZipMiddleware</span><span class="p">(</span><span class="n">GZipMiddleware</span><span class="p">):</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;Will GZip the content if it&#39;s not text/*, xml, or a javascript content type.&quot;&quot;&quot;</span>
</span><span class='line'><span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span><span class='line'><span class="n">ctype</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span class='line'><span class="k">if</span> <span class="ow">not</span> <span class="n">ctype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;text/&#39;</span><span class="p">)</span>\
</span><span class='line'><span class="ow">or</span> <span class="s">&#39;javascript&#39;</span> <span class="ow">in</span> <span class="n">ctype</span>\
</span><span class='line'><span class="ow">or</span> <span class="s">&#39;xml&#39;</span> <span class="ow">in</span> <span class="n">ctype</span><span class="p">:</span>
</span><span class='line'><span class="k">return</span> <span class="n">response</span>
</span><span class='line'><span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ImprovedGZipMiddleware</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-04-17T00:00:00-07:00" pubdate data-updated="true">Apr 17<span>th</span>, 2009</time></div>
        <div class="tags">

<div class="cat">
  
    <a class='category' href='/categories/django/'>django</a>
  
</div>

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2009/04/14/cleaning-up-with-json-and-sql">Cleaning Up With JSON and SQL in Django</a></h1>
    <div class="entry">
        <p>Most of our projects lately are now using JSON data storage in the database. This makes it very efficient for storing additional data without having to run alters are gigantic data sets. It also allows us to store different data for different kinds of sets within the same table.</p>

<p>Doing this in Django we originally created a JSONField. A simple custom field which would convert back and from from JSON to a Python object. Mostly this was going from a dictionary to a text-based form in the database (JSON). Recently in one project I took the time to update the field to fix a couple things as well as add support for it in the forms, and thus making it usable within the admin.</p>

<p>So, for the wanting, here&#8217;s our updated JSONField and the related form field.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">simplejson</span> <span class="k">as</span> <span class="n">json</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">JSONWidget</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Textarea</span><span class="p">):</span>
</span><span class='line'><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class='line'><span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
</span><span class='line'><span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">JSONWidget</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">JSONFormField</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">):</span>
</span><span class='line'><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class='line'><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;widget&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">JSONWidget</span>
</span><span class='line'><span class="nb">super</span><span class="p">(</span><span class="n">JSONFormField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span class='line'><span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span> <span class="k">return</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'><span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'><span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
</span><span class='line'><span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">u&#39;JSON decode error: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">exc</span><span class="p">),))</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">JSONField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">):</span>
</span><span class='line'><span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SubfieldBase</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">formfield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class='line'><span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">JSONField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">formfield</span><span class="p">(</span><span class="n">form_class</span><span class="o">=</span><span class="n">JSONFormField</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span class='line'><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
</span><span class='line'><span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'><span class="k">return</span> <span class="n">value</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_db_prep_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span class='line'><span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
</span><span class='line'><span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">value_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span><span class='line'><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_val_from_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span class='line'><span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_prep_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-04-14T00:00:00-07:00" pubdate data-updated="true">Apr 14<span>th</span>, 2009</time></div>
        <div class="tags">

<div class="cat">
  
    <a class='category' href='/categories/django/'>django</a>
  
</div>

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2009/04/04/refactoring-lifestream">Refactoring Lifestream</a></h1>
    <div class="entry">
        <p>For a while now I&#8217;ve been wanting to rewrite Lifestream into a contained OO pattern. It seems to be the &#8220;best practice&#8221; when it comes to WordPress, but tutorials and what are not spread out so it took a bit of time.</p>

<p>During the process, I also took the opportunity to speed up certain areas, such as option calls. Instead of storing options on a per-key basis, I changed it over to simply use a serialized arrays. In such, I added several new commands to the codebase:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">function _populate_option_cache()</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">    if (!$this-&gt;_optioncache)</span>
</span><span class='line'><span class="x">    {</span>
</span><span class='line'><span class="x">        $this-&gt;_optioncache = get_option(&#39;lifestream_options&#39;);</span>
</span><span class='line'><span class="x">        if (!$this-&gt;_optioncache) $this-&gt;_optioncache = $this-&gt;_options;</span>
</span><span class='line'><span class="x">    }</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">/**</span>
</span><span class='line'><span class="x">* Fetches the value of an option. Returns `null` if the option is not set.</span>
</span><span class='line'><span class="x">*/</span>
</span><span class='line'><span class="x">function get_option($option, $default=null)</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">    $this-&gt;_populate_option_cache();</span>
</span><span class='line'><span class="x">    $value = $this-&gt;_optioncache[$option];</span>
</span><span class='line'><span class="x">    if (!$value) {</span>
</span><span class='line'><span class="x">        return $default;</span>
</span><span class='line'><span class="x">    }</span>
</span><span class='line'><span class="x">    return $value;</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">/**</span>
</span><span class='line'><span class="x">* Removes an option.</span>
</span><span class='line'><span class="x">*/</span>
</span><span class='line'><span class="x">function delete_option($option)</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">    $this-&gt;_populate_option-cache();</span>
</span><span class='line'><span class="x">    unset($this-&gt;_optioncache[$option]);</span>
</span><span class='line'><span class="x">    update_option(&#39;lifestream_options&#39;, $this-&gt;_optioncache);</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">/**</span>
</span><span class='line'><span class="x">* Updates the value of an option.</span>
</span><span class='line'><span class="x">*/</span>
</span><span class='line'><span class="x">function update_option($option, $value)</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">    $this-&gt;_populate_option_cache();</span>
</span><span class='line'><span class="x">    $this-&gt;_optioncache[$option] = $value;</span>
</span><span class='line'><span class="x">    update_option(&#39;lifestream_options&#39;, $this-&gt;_optioncache);</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">/**</span>
</span><span class='line'><span class="x">* Sets an option if it doesn&#39;t exist.</span>
</span><span class='line'><span class="x">*/</span>
</span><span class='line'><span class="x">function add_option($option, $value)</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">    $this-&gt;_populate_option_cache();</span>
</span><span class='line'><span class="x">    if (!array_key_exists($option, $this-&gt;_optioncache))</span>
</span><span class='line'><span class="x">    {</span>
</span><span class='line'><span class="x">        $this-&gt;_optioncache[$option] = $value;</span>
</span><span class='line'><span class="x">        add_option(&#39;lifestream_options&#39;, serialize($this-&gt;_optioncache));</span>
</span><span class='line'><span class="x">    }</span>
</span><span class='line'><span class="x">}</span>
</span></code></pre></td></tr></table></div></figure>

From here I moved on to change all the translation calls <code>__</code>, and <code>_e</code> into using a built-in version of which automatically handles the sprintf calls, and the namespace.

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">function __($text, $params=null)</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">    if (!is_array($params))</span>
</span><span class='line'><span class="x">    {</span>
</span><span class='line'><span class="x">        $params = func_get_args();</span>
</span><span class='line'><span class="x">        $params = array_slice($params, 1);</span>
</span><span class='line'><span class="x">    }</span>
</span><span class='line'><span class="x">    return vsprintf(__($text, &#39;lifestream&#39;), $params);</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">function _e($text, $params=null)</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">    if (!is_array($params))</span>
</span><span class='line'><span class="x">    {</span>
</span><span class='line'><span class="x">        $params = func_get_args();</span>
</span><span class='line'><span class="x">        $params = array_slice($params, 1);</span>
</span><span class='line'><span class="x">    }</span>
</span><span class='line'><span class="x">    echo vsprintf(__($text, &#39;lifestream&#39;), $params);</span>
</span><span class='line'><span class="x">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>These two things alone cleaned up a LOT of the plugin, and the efficiency gain from the options change is amazing.</p>

<p>From there I decided to go all out, beyond just refactoring it into a class, I began adding some functionality from our upcoming service. Labels were moved out of the feed classes, and instead are now their own class. Each label is reusable, and controls how it&#8217;s events should be rendered. Doing this really opened the door to the possibilities of different styles of rendering for different media types.</p>

<p>So after a nice days work, I&#8217;ve pushed out <a href="http://wordpress.org/extend/plugins/lifestream/">wp-lifestream 0.96</a>, which contains an enormous amount of bug fixes, optimizations, and best of all new features. You can see it running live on my blog, with the new display styles and all. Hopefully tomorrow I will be able to finish up the permalinks for events, which will also give the ability to attach comments to them.</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-04-04T00:00:00-07:00" pubdate data-updated="true">Apr 4<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2009/04/02/problems-uploading-packages-with-setuptools-on-os-x">Problems Uploading Packages With Setuptools on OS X</a></h1>
    <div class="entry">
        <p>This is mostly a note to myself, but also since my blog is very helpful to fellow Google-users I figured I&#8217;d throw it up here publicly.</p>

<p>Today I needed to update a package on PyPi using setuptools:</p>

<pre>python setup.py sdist register upload</pre>

<p>The problem was, no matter what I did, I always seemed to get this error:</p>

<pre><strong>Upload failed (401): You must be identified to edit package information</strong></pre>

<p>I also noticed that while it was asking me to save my login information, and I hit Y everytime, it still asked me for the username and password. It turned out that it was saving the information incorrectly as follows:</p>

<pre><br>[pypi]<br>username:dcramer<br>password:*******<br></pre>

<p>Changing it out to this solved the problems:</p>

<pre><br>[server-login]<br>username:dcramer<br>password:********<br></pre>

<p>Can&#8217;t quite explain it, but as I&#8217;m sure other people have come across this same issue, maybe it will get resolved in the near future.</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-04-02T00:00:00-07:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2009/03/25/setting-up-django-and-sphinx-full-text-search-django-sphinx">Setting Up Django and Sphinx Full-text Search (Django-sphinx)</a></h1>
    <div class="entry">
        <p>A while back I posted a quick, and very simplistic guide to setting up django-sphinx within your project. Since that time we&#8217;ve gained a lot of use of the platform. It came to my attention today that the <a href="http://groups.google.com/group/django-nyc">django-nyc</a> group was going to do a presentation on how to setup sphinx within your Django project. This, and many, many questions later, I&#8217;ve decided to rewrite my guide to setting up Sphinx with your project.<br>
        
        <a href="/2009/03/25/setting-up-django-and-sphinx-full-text-search-django-sphinx" class="more-link">Read on &rarr;</a>
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-03-25T00:00:00-07:00" pubdate data-updated="true">Mar 25<span>th</span>, 2009</time></div>
        <div class="tags">

<div class="cat">
  
    <a class='category' href='/categories/django/'>django</a>
  
</div>

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2009/03/14/scaling-your-frontend-far-futures-headers-and-template-tags">Scaling Your Frontend: Far-Futures Headers and Template Tags</a></h1>
    <div class="entry">
        <p>One of the many things we do to help optimize our website load times is optimize the frontend by setting far-futures headers. This simply means that media has an Expires tag of sometime in the distant future (maybe a year), and when we make changes, the filename needs to change. The easiest way to do this, is by adding a simple GET parameter.</p>

<p>To handle this, we had been using a simple revision system, where we just increment a number in a list of files, and it appends that number to the filename. After realizing how lazy we should have been, I quickly rewrote it to grab the file modification time and use that as the revision number.</p>

<p>Anyways, we did this by using a simple template tag (or a global object as it&#8217;s known in Jinja), to output the URL to the file, as well as the revision.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">os.path</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">jinja.contrib.djangosupport</span> <span class="kn">import</span> <span class="n">register</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">mediaurl</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span><span class='line'><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</span><span class='line'><span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_PATH</span><span class="p">):</span>
</span><span class='line'><span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Media must be located within MEDIA_ROOT.&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">return</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">?</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_URL</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)))</span>
</span><span class='line'><span class="n">register</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">mediaurl</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

Now to link our media files it&#8217;s quick and painless:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="c">&lt;!-- iBegin Stylesheets --&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="na">href=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">media=</span><span class="s">&quot;print&quot;</span> <span class="na">href=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span><span class="c">&lt;!-- JavaScript --&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-03-14T00:00:00-07:00" pubdate data-updated="true">Mar 14<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2009/03/12/mac-os-x-security-update-2009-01-perl-fix">Mac OS X Security Update 2009-01 Fix for Perl and Fink</a></h1>
    <div class="entry">
        <p>As many users like myself probably have noticed, Apple seriously fucked us with their latest security release. From what I&#8217;ve read, they reverted Perl to an older version which doesn&#8217;t support some common features.</p>

<p>I began receiving errors such as the following with fink and other applications:</p>

<ul><li><strong>IO object version 1.22 does not match bootstrap parameter 1.23</strong></li><li>Storable object version 2.15 does not match $Storable::VERSION 2.18</li><li>DB_File object version 1.814 does not match bootstrap parameter 1.817</li></ul>

<p>After a bit of searching, and trying some various things, I&#8217;ve come up with the following solution (which may be specific to my problems):</p>

<pre><br>mkdir -p /fixforperl<br>cd !$<br>curl -O http://search.cpan.org/CPAN/authors/id/G/GB/GBARR/IO-1.2301.tar.gz<br>curl -O http://search.cpan.org/CPAN/authors/id/P/PM/PMQS/DB_File-1.819.tar.gz<br>curl -O http://search.cpan.org/CPAN/authors/id/A/AM/AMS/Storable-2.18.tar.gz<br>tar xzf IO-1.2301.tar.gz<br>tar xzf DB_File-1.819.tar.gz<br>tar xzf Storable-2.18.tar.gz<br>cd IO-1.2301 && perl Makefile.PL && make && sudo make install && cd ..<br>cd DB_File-1.819 && perl Makefile.PL && make && sudo make install && cd ..<br>cd Storable-2.18 && perl Makefile.PL && make && sudo make install && cd ..<br></pre>

<p>There may be other libraries which you need to update as well. These are just the ones I&#8217;ve encountered so far. The process is the same for each library. Simply grab the package off of CPAN, run the Makefile.PL, and make install.</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-03-12T00:00:00-07:00" pubdate data-updated="true">Mar 12<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2009/02/28/improved-uuidfield-in-django">Improved UUIDField in Django</a></h1>
    <div class="entry">
        <p>So today I went ahead and cleaned up my UUIDField implementation. Originally it was just based off of a snippet. I wanted to swap it over to use a BINARY column in MySQL, after reading on how <a href="http://bret.appspot.com/entry/how-friendfeed-uses-mysql">FriendFeed had been using UUIDs</a>. Due to using Django however, you can&#8217;t use binary data or BLOB columns effectively. It tries to coerce everything to unicode so it ends up failing on any kind of binary data.</p>

<p>Instead of using a BINARY(16) column, I just switched over to a CHAR(32) (previously a CHAR(36)). In doing this I also converted the field to keep everything in the UUID format (to better handle passing around the values, and converting to any format you want).</p>

<p>All in all, the new UUIDField works as intended, and is a nice improvement over the simple &#8220;automatically insert a UUID here&#8221;, which is what it was before.</p>

<p>Grab the code on <a href="https://github.com/dcramer/django-uuidfield">GitHub</a></p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-02-28T00:00:00-08:00" pubdate data-updated="true">Feb 28<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2009/02/22/javascript-widgets-on-nibbits">JavaScript Widgets on Nibbits</a></h1>
    <div class="entry">
        <p>Quite a while back I introduced basic JavaScript widgets on Nibbits. These let site owners embed a simple box on their own site which shows basic information, as well as a download link for their maps.</p>

<p>So, why am I posting about this? Simply to spread the word, and to demo it of course :)</p>

<p><script src="http://www.nibbits.com/wc3/maps/view/125228/widget.js"></script></p>

<p><script src="http://www.nibbits.com/sc/maps/view/125214/widget.js"></script></p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-02-22T00:00:00-08:00" pubdate data-updated="true">Feb 22<span>nd</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/2009/02/09/large-sql-result-sets-in-django">Large SQL Result Sets in Django</a></h1>
    <div class="entry">
        <p>One of the repetitive tasks that I always seem to have, is handling large amounts of data in chunks. That is, typically I loop through every row in the database, but the result set is too large, or too slow to take into memory all at once. After reading my code a few too many times, I realized how lazy I had been on the first iteration, and decided to dry it up.</p>

<p>So, the result, is a couple of useful classes for managing large QuerySet&#8217;s, and cursors in Django.</p>

<p>First let&#8217;s handle iterating over a large QuerySet. Let&#8217;s just say we have a million rows in our database, and need to write each one to the file. Now in some situations, this could be a locking query, which isn&#8217;t good. In others, it&#8217;s simply just too slow and network heavy to send all million rows over the network. What we do instead, which is a little bit slower (overall), is query for a chunk of data at a time, and simply yield the current results.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">IterableQuerySet</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Allows iteration over a QuerySet breaking it off into smaller chunks.&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">at</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="p">[</span><span class="n">at</span><span class="p">:</span><span class="n">at</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">]</span>
</span><span class='line'>        <span class="k">while</span> <span class="n">results</span><span class="p">:</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span><span class='line'>                <span class="k">yield</span> <span class="n">result</span>
</span><span class='line'>            <span class="n">at</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span>
</span><span class='line'>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="p">[</span><span class="n">at</span><span class="p">:</span><span class="n">at</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>

Now one of the other common tasks we had with similar applications, was doing something similar but with cursors. So instead of writing the same class, but for a cursor, we instead made a new class which would allow a cursor to easily act like a QuerySet. This one&#8217;s a bit more complex, but also allows you to use a Paginator class on it.

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'>
</span><span class='line'><span class="n">CURSOR_UNION_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^SELECT .*? FROM (.*)$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">QuerySetCursor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[],</span> <span class="n">model_class</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">params</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">connection</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span> <span class="o">=</span> <span class="n">sql</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span> <span class="o">=</span> <span class="n">model_class</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
</span><span class='line'>            <span class="k">raise</span> <span class="ne">TypeError</span>
</span><span class='line'>        <span class="k">assert</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> \
</span><span class='line'>            <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">stop</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)),</span> \
</span><span class='line'>                <span class="s">&quot;Negative indexing is not supported.&quot;</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="nb">slice</span><span class="p">:</span>
</span><span class='line'>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">&lt;</span> <span class="n">k</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">stop</span><span class="o">-</span><span class="n">k</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">:</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">):</span>
</span><span class='line'>                    <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="nb">slice</span><span class="p">:</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">stop</span><span class="o">-</span><span class="n">k</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_results</span><span class="p">()</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">k</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_results</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_results</span><span class="p">())</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">:</span>
</span><span class='line'>            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span> <span class="o">+</span> <span class="s">&#39; LIMIT </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span>
</span><span class='line'>            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">]</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>
</span><span class='line'>            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span class='line'>            <span class="n">results</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">:</span>
</span><span class='line'>                <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</span><span class='line'>        <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">results</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">statements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; UNION &#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">prepared</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">:</span>
</span><span class='line'>            <span class="n">end_of_stmt</span> <span class="o">=</span> <span class="n">CURSOR_UNION_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="n">end_of_stmt</span><span class="p">:</span>
</span><span class='line'>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Error getting SQL&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">prepared</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;SELECT COUNT(1) FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_of_stmt</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),))</span>
</span><span class='line'>        <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;SELECT (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;) + (&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prepared</span><span class="p">),)</span>
</span><span class='line'>        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
</span><span class='line'>            <span class="n">results</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>        <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">results</span>
</span></code></pre></td></tr></table></div></figure>

Want to combine both results?

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">IterableQuerySet</span><span class="p">(</span><span class="n">QuerySetCursor</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">MyModelClass</span><span class="p">)):</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">r</span>
</span></code></pre></td></tr></table></div></figure>
<p>I believe there&#8217;s also some optimization that can be doing with <code>cursor.fetchmany()</code> to also chunk the SQL in memory, but I&#8217;ve yet to research how the cursor classes work internally.</p>
        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-02-09T00:00:00-08:00" pubdate data-updated="true">Feb 9<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>

<nav id="pagenavi">
    
        <a href="/blog/page/4/" class="prev">Prev</a>
    
    
        <a href="/blog/page/6/" class="next">Next</a>
    
    <a href="/blog/archives" class="center">Blog Archives</a>
</nav></div>
	<footer class="inner">Copyright &copy; 2012 David Cramer &mdash; Need exceptional error logging? Try out <a href="https://www.getsentry.com">Sentry</a></footer>
	<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'davidcramer';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>
</html>